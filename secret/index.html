<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>NFC Writer</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet" />
<style>
  * {
    font-family: 'Inter', sans-serif !important;
    box-sizing: border-box;
  }
  body {
    margin: 0;
    background: #f0f2f5;
    color: #222;
    padding: 20px;
  }
  .container {
    max-width: 900px;
    margin: auto;
    background: white;
    padding: 24px;
    border-radius: 14px;
    box-shadow: 0 4px 16px rgba(0,0,0,0.07);
  }
  h2 { font-weight: 600; margin-bottom: 8px; }
  h3 { margin-top: 32px; }
  input {
    width: 100%;
    padding: 12px;
    margin-bottom: 14px;
    border-radius: 10px;
    border: 1px solid #ccc;
    font-size: 16px;
    background: #fafafa;
  }
  input::placeholder {
    color: #666 !important;
    opacity: 1 !important;
  }
  table {
    width: 100%;
    border-collapse: collapse;
    font-size: 15px;
  }
  th, td {
    padding: 10px;
    border-bottom: 1px solid #eee;
  }
  th {
    background: #f7f7f7;
    font-weight: 500;
    position: sticky;
    top: 0;
  }
  button {
    padding: 10px 16px;
    border: none;
    border-radius: 10px;
    cursor: pointer;
    font-size: 14px;
    font-weight: 500;
    letter-spacing: 0.2px;
  }
  .btn-primary { background: #0069ff; color: white; }
  .btn-green { background: #12b76a; color: white; }
  .btn-secondary { background: #eee; }
  pre {
    background: #f7f7f7;
    padding: 12px;
    border-radius: 10px;
    font-size: 13px;
    white-space: pre-wrap;
  }
  #lockScreen {
    position: fixed;
    inset: 0;
    background: white;
    z-index: 9999;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 20px;
  }
  #lockBox {
    background: #fff;
    padding: 30px;
    border-radius: 14px;
    max-width: 360px;
    width: 100%;
    box-shadow: 0 4px 16px rgba(0,0,0,0.08);
    text-align: center;
  }
  #blockedDevice {
    position: fixed;
    inset: 0;
    background: white;
    z-index: 9998;
    display: none;
    align-items: center;
    justify-content: center;
    padding: 20px;
    text-align: center;
    font-size: 18px;
  }
</style>
</head>
<body>

<div id="blockedDevice">
  <div>
    <h2>Unsupported Device</h2>
    <p id="blockedMessage">This tool works only on mobile phones with NFC and Chrome/Edge browsers.</p>
  </div>
</div>

<div id="lockScreen">
  <div id="lockBox">
    <h3>Enter Password</h3>
    <input type="password" id="passwordInput" placeholder="Password" />
    <button class="btn-primary" onclick="attemptLogin()">Unlock</button>
    <p id="loginStatus" style="color:#d33; margin-top:10px;"></p>
  </div>
</div>

<div class="container" id="mainContent" style="display:none;">
  <h2>NFC Writer</h2>
  <input id="search" placeholder="Search by name or ID…" />
  <div style="max-height:300px; overflow:auto; border:1px solid #ddd; border-radius:10px;">
    <table id="placesTable">
      <thead>
        <tr><th>ID</th><th>Place</th><th></th></tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <h3>Selected</h3>
  <div id="selectionBox">None</div>

  <button id="writeBtn" class="btn-green" style="margin-top:10px;" disabled>Write to NFC</button>

  <h3>Status</h3>
  <pre id="status">Idle.</pre>
</div>

<script>
const REQUIRED_HASH = "9faa5263190c0023bbef3abc07296dd9f757894878b0bf6d342eaf028c355a43";

function sha256(str) {
  const buf = new TextEncoder().encode(str);
  return crypto.subtle.digest("SHA-256", buf).then(hash => {
    return Array.from(new Uint8Array(hash))
      .map(b => b.toString(16).padStart(2, "0"))
      .join("");
  });
}

function attemptLogin() {
  const input = document.getElementById("passwordInput").value;
  const loginStatus = document.getElementById("loginStatus");

  sha256(input).then(hash => {
    if (hash === REQUIRED_HASH) {
      document.cookie = "embargo_auth=1; path=/; max-age=2592000";
      unlock();
    } else {
      loginStatus.textContent = "Incorrect password.";
    }
  });
}

function unlock() {
  document.getElementById("lockScreen").style.display = "none";
  document.getElementById("mainContent").style.display = "block";
  document.getElementById("status").textContent = "Ready. Select a place and tap Write to NFC.";
}

if (document.cookie.includes("embargo_auth=1")) {
  unlock();
}

const raw = `
26000            Kaiser
26016         Czytelnia
26017           Ginnery
26025            Bibi's
26028       Kura Warzyw
26036       Burger Shop
26041      Calavera Tex-Mex
26053-57         Jeff's
26086      Kawowa Glowa
26091       Serso Praskie Bajgle
26096     Krutoy Shishe
26100   Trejd 1980/Po drodze
26133     Kawiarnia KUT
26134       Bochena (Kawa)
26135       Bochena (Chleb)
26142          Otrebusy
26153-54   Kultura Kawy
26164-68    The Mexican
26169-70   Prosty Temat
26199            Kasier
26214        Semifreddo
26248       Greek House
26256           Makarun
26260      Be My Burger
26274        Coffeedesk
26281          Fit Cake
26330     Slodki Wiking
26344-45           STOR
26354       The Mexican
26355      Prosty Temat
26359      Metro Bistro & Bar
26461         Rzemioslo Paczkow i Lodow
`;

function fixPolish(s) {
  return s
    .replace(/Glowa/g, "Głowa")
    .replace(/Otrebusy/g, "Otrębusy")
    .replace(/Rzemioslo/g, "Rzemiosło")
    .replace(/Paczkow/g, "Pączków")
    .replace(/Lodow/g, "Lodów")
    .replace(/Slodki/g, "Słodki")
    .replace(/Kasier/g, "Kaiser");
}

function parsePlaces() {
  const lines = raw.trim().split("\n");
  const out = [];

  for (let line of lines) {
    line = line.trim();
    const m = line.match(/^([0-9-]+)\s+(.+)$/);
    if (!m) continue;

    const idPart = m[1];
    const name = fixPolish(m[2].trim());

    if (idPart.includes("-")) {
      const [startStr, endSuffix] = idPart.split("-");
      const start = parseInt(startStr, 10);
      const suffix = String(parseInt(endSuffix, 10));

      const prefix = startStr.slice(0, startStr.length - suffix.length);
      const end = parseInt(prefix + suffix, 10);

      for (let i = start; i <= end; i++) {
        const index = i - start + 1;
        out.push({ id: String(i), name: `${name} ${index}` });
      }
    } else {
      out.push({ id: idPart, name });
    }
  }
  return out;
}

const places = parsePlaces();

const tbody = document.querySelector("#placesTable tbody");

function renderList(list) {
  tbody.innerHTML = "";
  list.forEach(p => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${p.id}</td>
      <td>${p.name}</td>
      <td><button class="btn-primary" data-id="${p.id}">Select</button></td>
    `;
    tbody.appendChild(tr);
  });
}

renderList(places);

document.getElementById("search").addEventListener("input", e => {
  const q = e.target.value.toLowerCase();
  renderList(
    places.filter(p => p.name.toLowerCase().includes(q) || p.id.includes(q))
  );
});

let selected = null;

tbody.addEventListener("click", e => {
  if (e.target.tagName === "BUTTON") {
    const id = e.target.getAttribute("data-id");
    selected = places.find(p => p.id === id);
    document.getElementById("selectionBox").innerHTML =
      `<b>${selected.name}</b><br>ID: ${selected.id}`;
    document.getElementById("writeBtn").disabled = false;
    document.getElementById("status").textContent = "Ready to write NFC tag.";
  }
});

async function writeTag() {
  const status = document.getElementById("status");
  const blockedDevice = document.getElementById("blockedDevice");

  if (!("NDEFWriter" in window)) {
    blockedDevice.style.display = "flex";
    document.getElementById("blockedMessage").textContent = "Web NFC is not supported on this device/browser.";
    status.textContent = "Web NFC not supported.";
    return;
  }

  if (!selected) {
    status.textContent = "Please select a place first.";
    return;
  }

  try {
    status.textContent = "Tap NFC tag to write data…";

    const writer = new NDEFWriter();
    await writer.write({
      records: [
        { recordType: "text", data: `10001-${selected.id}` },
        { recordType: "url", data: `embargoapp://beaconID=${selected.id}` },
        {
          recordType: "mime",
          mediaType: "application/vnd.com.embargo.app",
          data: new TextEncoder().encode("com.embargo.app")
        }
      ]
    });

    status.textContent = "SUCCESS – tag written.";
  } catch (err) {
    status.textContent = "ERROR: " + err.message;
  }
}

document.getElementById("writeBtn").addEventListener("click", writeTag);
</script>
</body>
</html>
